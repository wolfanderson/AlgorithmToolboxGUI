# 中文显示问题解决方案

## 问题描述

OCR识别后，识别的中文字符显示为"？"或乱码。

## 问题原因

1. **OpenCV不支持中文字符**: `cv2.putText()` 函数只能显示ASCII字符，无法正确显示中文
2. **JSON编码问题**: Flask默认使用ASCII编码JSON响应
3. **字体问题**: 浏览器可能缺少中文字体

## 解决方案

### 1. 后端修复

#### ✅ Flask JSON编码设置
在 `app.py` 中添加：
```python
app.config['JSON_AS_ASCII'] = False
```
确保JSON响应使用UTF-8编码，而不是ASCII。

#### ✅ 图像上中文文本绘制
创建了 `algorithms/cv2_utils.py` 工具模块，使用PIL（Pillow）绘制中文文本：

```python
from algorithms.cv2_utils import put_text_safe

# 替代 cv2.putText()
result = put_text_safe(result, "中文文本", (x, y), 
                      font_size=18, color=(0, 255, 0))
```

**工作原理**:
- 自动检测文本是否包含中文字符
- 如果包含中文，使用PIL绘制（支持中文）
- 如果是英文，使用OpenCV绘制（性能更好）

### 2. 前端修复

#### ✅ HTML字符集设置
确保HTML文件设置了UTF-8编码：
```html
<meta charset="UTF-8">
```

#### ✅ CSS字体设置
在 `static/index.html` 中为输出文本区域添加中文字体：
```html
<div id="outputText" style="font-family: 'Microsoft YaHei', 'SimHei', Arial, sans-serif;">
```

#### ✅ JavaScript文本显示
在 `static/app.js` 中改进文本显示逻辑：
```javascript
// 确保正确显示中文字符
outputText.textContent = result.text;
// 如果textContent显示为?，尝试使用innerText
if (outputText.textContent.includes('?') && result.text && !result.text.includes('?')) {
    outputText.innerText = result.text;
}
```

## 已修复的文件

1. **app.py**: 添加 `JSON_AS_ASCII = False` 配置
2. **algorithms/cv2_utils.py**: 新建中文文本绘制工具
3. **algorithms/ocr_recognition.py**: 使用 `put_text_safe()` 替代 `cv2.putText()`
4. **static/index.html**: 添加中文字体支持
5. **static/app.js**: 改进文本显示逻辑

## 验证修复

### 测试步骤

1. **重启服务**
   ```bash
   python app.py
   ```

2. **上传包含中文的图片**
   - 点击"上传图片"
   - 选择包含中文文字的图片

3. **添加OCR节点**
   - 从左侧拖拽"OCR识别"到画布

4. **执行工作流**
   - 点击"执行工作流"按钮

5. **检查结果**
   - **图像上的文字**: 应该正确显示中文（不再是"？"）
   - **文本输出区域**: 应该正确显示识别到的中文文本

## 字体支持

### Windows系统
- 自动使用 `C:/Windows/Fonts/msyh.ttc` (微软雅黑)

### macOS系统
- 自动使用 `/System/Library/Fonts/PingFang.ttc` (苹方)

### Linux系统
- 尝试使用 `/usr/share/fonts/truetype/dejavu/DejaVuSans.ttf`
- 如果失败，可能需要安装中文字体：
  ```bash
  # Ubuntu/Debian
  sudo apt-get install fonts-wqy-microhei
  
  # CentOS/RHEL
  sudo yum install wqy-microhei-fonts
  ```

### 自定义字体

如果需要使用特定字体，可以修改 `algorithms/cv2_utils.py` 中的字体路径：

```python
font = ImageFont.truetype('path/to/your/font.ttf', font_size)
```

## 常见问题

### Q: 图像上的中文仍然显示为"？"

**A**: 检查系统是否安装了中文字体：
- Windows: 通常已安装微软雅黑
- macOS: 通常已安装苹方
- Linux: 可能需要手动安装中文字体

### Q: 文本输出区域显示乱码

**A**: 
1. 检查浏览器控制台是否有编码错误
2. 确认后端返回的JSON是否正确编码
3. 尝试刷新页面（Ctrl+F5）

### Q: 某些中文字符仍然无法显示

**A**: 
1. 检查字体文件是否包含该字符
2. 尝试使用其他字体（如思源黑体、文泉驿等）
3. 查看控制台错误信息

## 技术细节

### OpenCV vs PIL

| 特性 | OpenCV | PIL |
|------|--------|-----|
| 中文支持 | ❌ 不支持 | ✅ 支持 |
| 性能 | ✅ 快 | ⚠️ 较慢 |
| 字体选择 | ❌ 有限 | ✅ 灵活 |

### 性能优化

`put_text_safe()` 函数会自动检测文本内容：
- **纯英文**: 使用OpenCV（快速）
- **包含中文**: 使用PIL（支持中文）

这样既保证了中文显示，又保持了英文文本的绘制性能。

## 更新日志

- **2024-12-01**: 
  - 添加Flask JSON编码配置
  - 创建中文文本绘制工具
  - 修复OCR模块中的文本绘制
  - 改进前端文本显示逻辑

---

**提示**: 如果问题仍然存在，请检查：
1. Python版本（推荐3.8-3.11）
2. Pillow库是否正确安装
3. 系统字体是否完整
4. 浏览器控制台的错误信息

